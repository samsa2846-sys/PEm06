# Changelog - Улучшения функций

## Общие улучшения для обеих функций

### ✅ Сохранение API контракта
- Поддержка старых полей (`imageBase64`, `audioBase64`) и новых (`image`, `audio`)
- Обратная совместимость со старыми запросами
- Поддержка `event.isBase64Encoded` для корректной обработки base64

### ✅ Архитектурные улучшения
- Использование `axios` для всех HTTP запросов
- Константы и конфигурация вынесены в отдельные блоки
- Созданы вспомогательные функции для повторяющейся логики
- Улучшена обработка ошибок с детальными сообщениями

### ✅ Валидация
- Сохранены существующие лимиты размеров
- Добавлены четкие сообщения об ошибках с HTTP статус кодами
- Проверка наличия обязательных полей
- Валидация HTTP метода (только POST)

### ✅ Обработка запросов
- Функция `parseRequestBody()` обрабатывает:
  - Обычный JSON (`event.body` как строка)
  - Base64 закодированный JSON (`event.isBase64Encoded = true`)
  - Прямой объект (`event.body` как объект)

## Функция распознавания паспорта (`passport/index.js`)

### Новый API контракт

**ВХОД:**
- Метод: POST
- Поле: `image` или `imageBase64` (base64 строка)
- Поддержка: `event.isBase64Encoded`

**ВЫХОД (успех):**
```json
{
  "success": true,
  "last_name": "КОЗЛОВ",
  "first_name": "ВЯЧЕСЛАВ",
  "middle_name": "ВАЛЕРЬЕВИЧ",
  "birth_date": "03.06.1970",
  "birth_place": "ЯКУТСК",
  "passport_number": "4515161589",
  "citizenship": "Россия"
}
```

**ВЫХОД (ошибка):**
```json
{
  "error": "Тип ошибки",
  "message": "Детальное описание"
}
```

### Улучшения
- ✅ Новый промпт для GPT с детальными инструкциями
- ✅ Валидация формата даты рождения (ДД.ММ.ГГГГ)
- ✅ Валидация номера паспорта (ровно 10 цифр)
- ✅ Улучшенная обработка ошибок Vision и GPT API
- ✅ JSDoc комментарии для всех функций

### Статус коды
- `200` - Успешная обработка
- `400` - Некорректный запрос (отсутствует поле, неверный base64, размер)
- `405` - Метод не разрешен (не POST)
- `415` - Неподдерживаемый формат изображения
- `422` - Не удалось распознать текст
- `500` - Внутренняя ошибка сервера

## Функция обработки аудио (`audio/index.js`)

### Новый API контракт

**ВХОД:**
- Метод: POST
- Поле: `audio` или `audioBase64` (base64 строка, OGG аудио)
- Поддержка: `event.isBase64Encoded`

**ВЫХОД (успех):**
```json
{
  "success": true,
  "bank_name": "Сбербанк",
  "phone_number": "9015477837",
  "raw_text": "распознанный текст",
  "processing_info": {
    "gpt_used": true,
    "gpt_error": null,
    "fallback_used": false
  }
}
```

**ВЫХОД (ошибка):**
```json
{
  "error": "Тип ошибки",
  "message": "Детальное описание"
}
```

### Улучшения
- ✅ Новый промпт для GPT с примерами преобразования номеров
- ✅ Сложная функция `extractTenDigitPhone()` с 6 алгоритмами:
  1. Удаление всех нецифровых символов и поиск после префикса 7/8
  2. Поиск паттерна с префиксом +7 или 8
  3. Поиск 10 последовательных цифр
  4. Поиск паттерна (XXX) XXX-XX-XX
  5. Поиск 11 цифр с префиксом, извлечение последних 10
  6. Поиск любых 10 последовательных цифр
- ✅ Информация о процессе обработки в `processing_info`
- ✅ Fallback механизм при ошибке GPT
- ✅ Возврат `raw_text` в ответе
- ✅ JSDoc комментарии для всех функций

### Статус коды
- `200` - Успешная обработка
- `400` - Некорректный запрос (отсутствует поле, неверный base64, размер)
- `405` - Метод не разрешен (не POST)
- `422` - Не удалось распознать речь
- `500` - Внутренняя ошибка сервера

## Обратная совместимость

Обе функции поддерживают старые и новые форматы запросов:

**Старый формат (поддерживается):**
```json
{
  "imageBase64": "...",
  "audioBase64": "..."
}
```

**Новый формат:**
```json
{
  "image": "...",
  "audio": "..."
}
```

**Base64 кодирование:**
- Обычный JSON: `event.body` как строка
- Base64 JSON: `event.isBase64Encoded = true`, `event.body` как base64 строка

## Тестирование

Рекомендуется протестировать:
1. ✅ Запросы со старыми полями (`imageBase64`, `audioBase64`)
2. ✅ Запросы с новыми полями (`image`, `audio`)
3. ✅ Base64 закодированные запросы
4. ✅ Обычные JSON запросы
5. ✅ Валидацию размеров файлов
6. ✅ Обработку ошибок API
7. ✅ Fallback механизм для номеров телефонов




